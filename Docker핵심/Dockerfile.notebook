# Dockerfile.notebook - Project Odysseus ë°ì´í„° ë¶„ì„ ì „ìš© Jupyter í™˜ê²½
FROM jupyter/scipy-notebook:latest

# ë©”íƒ€ë°ì´í„°
LABEL maintainer="Project Odysseus Team"
LABEL description="Data Analysis Environment for Trading Bot"

# root ì‚¬ìš©ìë¡œ ì „í™˜ (íŒ¨í‚¤ì§€ ì„¤ì¹˜ìš©)
USER root

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    # ì»´íŒŒì¼ ë„êµ¬
    build-essential \
    gcc \
    g++ \
    # PostgreSQL í´ë¼ì´ì–¸íŠ¸
    libpq-dev \
    # TA-Lib
    libta-lib0-dev \
    # ìœ í‹¸ë¦¬í‹°
    curl \
    wget \
    git \
    vim \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# jovyan ì‚¬ìš©ìë¡œ ì „í™˜
USER $NB_UID

# Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
COPY requirements.txt /tmp/requirements.txt

# ë°ì´í„° ë¶„ì„ì— íŠ¹í™”ëœ íŒ¨í‚¤ì§€ë“¤ ì¶”ê°€ ì„¤ì¹˜
RUN pip install --no-cache-dir \
    # ê¸°ë³¸ requirements
    -r /tmp/requirements.txt && \
    # ì¶”ê°€ ë¶„ì„ ë„êµ¬ë“¤
    pip install --no-cache-dir \
    # ê³ ê¸‰ ì‹œê°í™”
    plotly-dash \
    bokeh \
    altair \
    # ì‹œê³„ì—´ ë¶„ì„
    fbprophet \
    pmdarima \
    # ê¸ˆìœµ ë¶„ì„
    yfinance \
    quantlib-python \
    # ê³ ì„±ëŠ¥ ë°ì´í„° ì²˜ë¦¬  
    dask[complete] \
    vaex \
    # ë°±í…ŒìŠ¤íŒ…
    backtrader \
    zipline-reloaded \
    # í†µê³„ ë¶„ì„
    pingouin \
    # ë„¤íŠ¸ì›Œí¬ ë¶„ì„
    networkx \
    # ì§€ë„ ì‹œê°í™”
    folium \
    geopandas \
    # Jupyter í™•ì¥
    jupyterlab-git \
    jupyter-dash \
    ipywidgets \
    # TA-Lib (ì„ íƒì )
    && pip install --no-cache-dir TA-Lib || echo "TA-Lib installation failed"

# Jupyter Lab í™•ì¥ ì„¤ì¹˜
RUN jupyter labextension install \
    @jupyter-widgets/jupyterlab-manager \
    plotlywidget \
    jupyterlab-plotly \
    || echo "Some extensions failed to install"

# ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /home/jovyan/work/notebooks \
             /home/jovyan/work/data \
             /home/jovyan/work/models \
             /home/jovyan/work/results

# Jupyter ì„¤ì • íŒŒì¼ ìƒì„±
RUN mkdir -p /home/jovyan/.jupyter

# Jupyter ì„¤ì •
COPY <<EOF /home/jovyan/.jupyter/jupyter_notebook_config.py
# Jupyter Notebook Configuration for Project Odysseus

# ë„¤íŠ¸ì›Œí¬ ì„¤ì •
c.NotebookApp.ip = '0.0.0.0'
c.NotebookApp.port = 8888
c.NotebookApp.allow_root = True
c.NotebookApp.token = ''
c.NotebookApp.password = ''

# ë³´ì•ˆ ì„¤ì • (ê°œë°œ í™˜ê²½ìš©)
c.NotebookApp.disable_check_xsrf = True
c.NotebookApp.allow_origin = '*'
c.NotebookApp.allow_credentials = True

# íŒŒì¼ ê´€ë ¨ ì„¤ì •
c.NotebookApp.open_browser = False
c.NotebookApp.notebook_dir = '/home/jovyan/work'

# ì„¸ì…˜ ì„¤ì •
c.NotebookApp.shutdown_no_activity_timeout = 7200  # 2ì‹œê°„

# í™•ì¥ ì„¤ì •
c.NotebookApp.nbserver_extensions = {
    'jupyter_dash.server': True
}
EOF

# JupyterLab ì„¤ì •
COPY <<EOF /home/jovyan/.jupyter/jupyter_lab_config.py
# JupyterLab Configuration

c.ServerApp.ip = '0.0.0.0'
c.ServerApp.port = 8888
c.ServerApp.allow_root = True
c.ServerApp.token = ''
c.ServerApp.password = ''
c.ServerApp.disable_check_xsrf = True
c.ServerApp.allow_origin = '*'
c.ServerApp.open_browser = False
c.ServerApp.root_dir = '/home/jovyan/work'
EOF

# ìƒ˜í”Œ ë…¸íŠ¸ë¶ ìƒì„±
COPY <<EOF /home/jovyan/work/notebooks/01_data_exploration.ipynb
{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Project Odysseus - ë°ì´í„° íƒìƒ‰\n",
    "## í˜ì–´ íŠ¸ë ˆì´ë”© ë°ì´í„° ë¶„ì„ ë° ì‹œê°í™”"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "import numpy as np\n",
    "import plotly.graph_objects as go\n",
    "import plotly.express as px\n",
    "from plotly.subplots import make_subplots\n",
    "import psycopg2\n",
    "import ccxt\n",
    "\n",
    "# ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •\n",
    "import os\n",
    "DB_CONFIG = {\n",
    "    'host': os.getenv('DB_HOST', 'timescaledb'),\n",
    "    'port': os.getenv('DB_PORT', 5432),\n",
    "    'database': os.getenv('DB_NAME', 'odysseus_trading'),\n",
    "    'user': os.getenv('DB_USER', 'postgres'),\n",
    "    'password': os.getenv('DB_PASSWORD', 'odysseus_secure_2024')\n",
    "}\n",
    "\n",
    "print('ğŸš€ Project Odysseus ë¶„ì„ í™˜ê²½ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!')"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## 1. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "# TimescaleDB ì—°ê²° í…ŒìŠ¤íŠ¸\n",
    "try:\n",
    "    conn = psycopg2.connect(**DB_CONFIG)\n",
    "    cursor = conn.cursor()\n",
    "    cursor.execute('SELECT version();')\n",
    "    version = cursor.fetchone()[0]\n",
    "    print(f'âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ: {version}')\n",
    "    cursor.close()\n",
    "    conn.close()\n",
    "except Exception as e:\n",
    "    print(f'âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨: {e}')"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
EOF

# ê¶Œí•œ ì„¤ì •
RUN chown -R $NB_UID:$NB_GID /home/jovyan/

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8888

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /home/jovyan/work

# ì‹œì‘ ëª…ë ¹ì–´
CMD ["start-notebook.sh", \
     "--NotebookApp.token=''", \
     "--NotebookApp.password=''", \
     "--NotebookApp.allow_root=True"]